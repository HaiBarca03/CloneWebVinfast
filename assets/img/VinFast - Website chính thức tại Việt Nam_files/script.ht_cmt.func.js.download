function ht_cmt_handler(){if(sessionStorage.getItem('name')!=undefined&&sessionStorage.getItem('name')!=undefined){jQuery('input[name="cmt_name"]').val(sessionStorage.getItem('name'));}
ht_submit_cmt('.cmt-form.main .cmt_submit_btn');jQuery(document).on('click','.reply-btn',function(event){if(!jQuery(this).next().length){var reply_html='';reply_html+='<div class="cmt-form">';reply_html+='<input type="text" name="cmt_name" placeholder="Nhập tên của bạn">';reply_html+='<textarea maxlength="100" name="cmt_content" placeholder="Viết phản hồi của bạn">@'+jQuery(this).attr('name')+': </textarea>';reply_html+='<div class="reply_submit_btn ht_transition" onclick="ht_submit_cmt(\'.reply_submit_btn\');">GỬI BÌNH LUẬN</div>';reply_html+='</div>';jQuery(this).after(reply_html);}else{jQuery(this).next().remove();}});}
function ht_submit_cmt(target){jQuery(document).on('click',target,function(event){var btn=jQuery(this);var nid=drupalSettings.path.currentPath.replace('node/','');var name=btn.siblings('input').val().replace(/(<([^>]+)>)/gi,"");var content=btn.siblings('textarea').val().replace(/(<([^>]+)>)/gi,"");if(name==''){ht_dialog_box('Lỗi','Yêu cầu nhập tên.','error_dialog');return false;}
if(content==''){ht_dialog_box('Lỗi','Chưa nhập nội dung bình luận.','error_dialog');return false;}
var node_fields={type:'comment',title:name,field_owner:{value:name},field_related_news:{value:nid},body:{value:content},};if(btn.hasClass('reply_submit_btn')){node_fields.field_parent_cmt={value:btn.parents('.cmt-form').prev().attr('cmid')};node_fields.field_reply_for={value:btn.parents('.cmt-form').prev().attr('user')};}
grecaptcha.execute('6Lcfbd4ZAAAAAN6cGzaskOw2AYFQPqxVlxHViEqv',{action:'submit'}).then(function(token){var params={access_key:'cmt_submit',nid:nid,node_fields:node_fields,captcha:token};ht_call_ajax(drupalSettings.path.baseUrl+'ht_cmt/ajax',params,function(r){console.log(r);if(r=='Error System.'){ht_dialog_box('Thông báo','Hệ thống bận. Vui lòng thử lại sau.','confirm_dialog');return false;}
if(!r.is_error){ht_dialog_box('Thông báo','Bình luận của bạn đang được chờ xét duyệt.','confirm_dialog');sessionStorage.setItem('name',name);jQuery('.cmt-form.main textarea').val('');if(btn.hasClass('reply_submit_btn')){btn.parents('.cmt-form').hide();setTimeout(function(){btn.parents('.cmt-form').remove();},500);}
return false;}
ht_dialog_box('Có lỗi xảy ra','Hệ thống bận. Vui lòng thử lại sau.','error_dialog');});});});}